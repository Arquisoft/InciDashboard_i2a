<!DOCTYPE html>
<html lan="en">
	<head th:replace="fragments/head"/>
	<body>
		<nav th:replace="fragments/nav" />
		<div class="container">
			<h2>Incident dashboard:</h2>
			<div class="panel panel-default">	
				<div class="panel-body">
					<p><span sec:authentication="principal.username"></span> - <span>The following are a list of active incidents in the system </span>
					<button type="button" class="btn btn-primary" id="updateButton">Update</a>
				</div>
				
				<script th:inline="javascript">
					/*<![CDATA[*/
					$("#updateButton").click(function() {
						 var urlUpdate = '/dashboard/update';
						 $("#dashboardInfo").load(urlUpdate);
					 });
					/*]]>*/
				</script>
				
				<div th:fragment="dashboardInfo" id="dashboardInfo">				
					<div class="card">
						<h5 class="card-header">
							Active incidents location
						</h5>
						<div class="card-body">
							<div id="mapa" style="width:100%;height:400px"></div>
						</div>
					</div>	
					
					<script th:inline="javascript">
						/*<![CDATA[*/
							function initMap(){
								var initialLatLng = {lat: 40.6753526, lng:-6.6971668};
								var map = new google.maps.Map(document.getElementById("mapa"), {
									zoom: 5,  
									center: initialLatLng          
							    });		
								
								var incidents = [[${incidentsList}]];
								var activeOperator = [[${activeOperator}]];
								var markers = [];
								var infoWindows = [];
								for(i=0; i<incidents.length; i++){
									var inciLocation = {
											lat: parseFloat(incidents[i].location.lat),
											lng: parseFloat(incidents[i].location.lng)
									}
									markers[i] = new google.maps.Marker({
										position: inciLocation,
										title: incidents[i].name,
										map: map
									});
									markers[i].index = i;
									markers[i].link = "/incident/edit/" + incidents[i].id;
									
									var contentString = "<div id='content'>" +
										"<h3 id='firstHeading'>" + incidents[i].name + "</h3>" +
										"<div id='bodyContent'>" + 
											"<p>Submitted by: " + incidents[i].agent.username + "</p>" +
											"<p>Agent type: " + incidents[i].agent.kind + "</p>" +
											"<p>State: " + incidents[i].state + "</p>" + 
											"<a href='" +  markers[i].link + "'>Modify incident</a>" +
										"</div>" + 
										"</div>";
										
									infoWindows[i] = new google.maps.InfoWindow({
									    content: contentString
									});
									
									google.maps.event.addListener(markers[i], 'click', function(){
										infoWindows[this.index].open(map, this);
									});					
									
									if(incidents[i].operator.email == activeOperator.email){
										google.maps.event.addListener(markers[i], 'dblclick', function(){
											window.open(this.link, "_self");
										});
									}														
								}		
								// Add a marker clusterer to manage the markers.
						        var markerCluster = new MarkerClusterer(map, markers,
						            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
							}
						/*]]>*/
					</script>
					 <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
					<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAr9ogXGdZ9_qScXx3Pd8Rg0Kv5TuSV_U&callback=initMap" async defer></script>
					
					<br>
					
					<div class="card" id="cardPieChart">
						<h5 class="card-header">
							State comparison of active incidents
						</h5>
						<div class="card-body">
							<div id="piechart" style="width:100%;height:400px"></div>
						</div>
					</div>
					
					<br>
					
					<div class="card" id="cardLineChart">
						<h5 class="card-header">
							Temperature evolution of incidents submitted by sensors
						</h5>
						<div class="card-body">
							<div id="linechart" style="width:100%;height:400px"></div>
						</div>
					</div>
					
					<script th:inline="javascript">
						/*<![CDATA[*/
							google.charts.load('current', {'packages':['corechart']});
	      					google.charts.setOnLoadCallback(drawChart);
	      					
	      					function drawChart(){
	      						var incidents = [[${incidentsList}]];
	      						var countOpen = 0;
	      						var countClosed = 0;
	      						var countCancelled = 0;
	      						var countInProcess = 0;
	      						
	      						var values = [
	      							["Time"]   							
	      						];
	      						var initial = 0;
	      						for(i=0; i<incidents.length; i++){
	      							if(incidents[i].state == "OPEN"){
	      								countOpen++;
	      							}
	      							else if(incidents[i].state == "CLOSED"){
	      								countClosed++;
	      							}
	      							else if(incidents[i].state == "CANCELLED"){
	      								countCancelled++;
	      							}
	      							else{
	      								countInProcess++;
	      							}      							
	      							
	      							if(incidents[i].agent.kind == "SENSOR"){
	      								values[0].push(incidents[i].name);
	      								var inciTemps = (incidents[i].properties[0])["temp"];
	      								if(inciTemps != null){
	      									for(j=0; j<inciTemps.length; j++){
	          									var tempInfo = inciTemps[j].split("-");
	          									var time = tempInfo[0];
	          									var temp = tempInfo[1];
	          									var index = j + 1;
	          									if(initial==0){
	          										values.push([]);
	          										values[index].push(time);
	          									}
	          									values[index].push(parseFloat(temp));
	          								}    
	          								initial = 1;
	      								}      								
	      							}
	      						}    						
	      						
	      						if(incidents.length > 0){
	      							document.getElementById("cardPieChart").style.display = "block";
		      						var data = google.visualization.arrayToDataTable([
		      				          ['Incident State', 'Number of Incidents'],
		     				          ['OPEN',     		countOpen],
		      				          ['CLOSED',      	countClosed],
		      				          ['CANCELLED',  	countCancelled],
		      				          ['IN_PROCESS', 	countInProcess]
		      				        ]);
		      						
		      						var options = {
		      								title: "State comparison of active incidents",
		      								is3D: true,
		      								height: 400
		      						};
		      						
		      						var chart = new google.visualization.PieChart(document.getElementById('piechart'));
		      						chart.draw(data, options);
	      						}
	      						
	      						if(values.length > 1){
	      							document.getElementById("cardLineChart").style.display = "block";
	      							var options = {
	          								title: "Temperature evolution of incidents submitted by sensors",
	          								legend: {position: "bottom"},
	          								height: 400
	          						};
	          						
	          						
	          						var chart = new google.visualization.LineChart(document.getElementById('linechart'));
	          						chart.draw(google.visualization.arrayToDataTable(values), options);
	      						}      						
	      					}
							
						/*]]>*/
					</script>
					
					<br>
					
					<div class="card">
						<h5 class="card-header">
							Active incidents details
						</h5>
						<div class="card-body table-responsive">
							<table class="table" name="tableIncidents">
								<thead class="thead-light">
									<tr>
										<th>Agent</th>
										<th>Agent kind</th>
										<th>Incident name</th>
										<th>Location</th>
										<th>State</th>
										<th>Properties</th>
										<th>Operator</th>
										<th>Comments</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="incident : ${incidentsList}">
										<td th:text="${incident.agent.username}">Agent</td>
										<td th:text="${incident.agent.kind}">Agent kind</td>
										<td th:text="${incident.name}">Incident name</td>
										<td th:text="${incident.location.toString()}">Incident location</td>
										<td th:text="${incident.state.toString()}">Incident state</td>									
										<td th:text="${incident.properties.toString()}">Incident properties</td>
										<td th:text="${incident.operator.email}">Operator</td>
										<td th:text="${incident.comments.toString()}">Incident comments</td>
										<div th:if="${incident.operator.email == activeOperator.email}">
											<td><a class="btn btn-primary" role="button" th:href="${'/incident/edit/' + incident.id}">Modify</a></td>
										</div>
									</tr>
								</tbody>				
							</table>
						</div>
					</div>	
				</div>		
			</div>				
		</div>
		
		<footer th:replace="fragments/footer"/>
	</body>
</html>